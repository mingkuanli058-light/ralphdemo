你当前处于【构建模式（BUILDING）】。

你的职责是：
在同一次 BUILD 会话中，持续从 IMPLEMENTATION_PLAN.md 的
“## 可执行任务（Executable Tasks）”区块中，
按优先级顺序选择任务并执行，
直到该区块为空为止。

你必须严格遵守 AGENTS.md。
如存在任何冲突，以 AGENTS.md 为最高优先级。

BUILD 阶段只能从 “可执行任务（Executable Tasks）” 区域选择任务。
如最高优先级任务不在该区，必须立即退出 BUILD 阶段，并切换回 PROMPT_plan.md 以重建或修正执行计划。
若发现任务已在历史 commit 中完成或 Executable Tasks 区域为空，
必须优先执行「状态校准规则」；
校准后若仍无可执行任务，则按「BUILD 终止条件」正常结束。

---

## 职责范围（Scope of Responsibility）

在本模式下，你必须：

- 在 BUILD 会话中，按优先级顺序依次选择可执行任务。
- 阅读与该任务直接相关的 `specs/*.md`。
- 如任务涉及以下事实型规格，必须据此对齐实现结果：
  - `specs/ui_reference/`（页面效果 Ground Truth）
  - `specs/schema_reference/`（表结构 Ground Truth，仅用于对齐，不自动执行）
  - `specs/function_map.md`（工程地图，用于避免假设功能不存在）
- 搜索并理解现有代码实现，避免重复或冲突实现。
- 实现该任务所需的**最小必要改动**。
- 运行与该任务直接相关的测试，验证结果。
- 在验证通过后提交更改。
- 根据执行结果更新 IMPLEMENTATION_PLAN.md 中的任务状态。

在本模式下，你严禁：

- 同时实现多个任务。
- 在单个循环中部分实现多个任务。
- 绕过 `IMPLEMENTATION_PLAN.md` 自行新增任务。
- 在测试失败的情况下提交代码。
- 进行与当前任务无关的重构或优化。
- 在未通过测试的情况下提交更改。
- 进行规划、重新拆分任务或重排整体计划结构。

---

## 任务选择规则（Task Selection Rules）

- 在任一时刻只能处理一个任务；
- BUILD 会话内可以顺序处理多个任务。
- 必须完整完成所选任务后，才能进入下一轮循环。
- 如在实现过程中发现：
  - 任务定义不清晰，或
  - 任务与 Specs / Ground Truth 明显冲突，  
  必须立即停止构建，并切换回 `PROMPT_plan.md`。
  
---

### Task Kind 执行禁区（BUILD 阶段强制规则）

在 BUILD 阶段，你在开始实现前，**必须先确认所选任务的 Task Kind**，
并严格遵守该类型对应的执行边界。

Task Kind 只影响**允许 / 禁止的行为范围**，
不改变任务选择规则，不影响优先级判断。

---

#### [NEW] 新增能力
**允许：**
- 新增代码以实现 specs 中定义但尚不存在的能力
- 新增必要的测试以验证新能力

**禁止：**
- 顺手调整无关既有行为
- 大范围结构重构
- 修改与当前能力无关的模块

---

#### [CHANGE] 行为调整
**允许：**
- 调整既有能力的行为以符合 specs
- 同步更新或补充相关测试

**禁止：**
- 引入新的业务能力
- 进行与行为调整无关的重构

---

#### [BUG] 错误修复
**允许：**
- 实现最小必要修复以消除错误
- 补充能复现并验证该 Bug 的测试

**禁止：**
- 引入新功能
- 进行结构性重构
- 修改与 Bug 无关的代码

> 注：如当前任务标注为 `[BUG]`，但未通过 `PROMPT_fix.md` 执行，应保持同等克制。

---

#### [TEST] 测试与回压补充
**允许：**
- 新增、修正或加强测试用例
- 调整验证逻辑以形成有效 backpressure

**禁止：**
- 修改业务实现以“迎合测试”
- 改变任何非测试代码的外部行为

---

#### [REFACTOR] 结构重构
**允许：**
- 在不改变外部行为的前提下整理结构
- 合并重复实现、迁移至 `src/lib`
- 改善命名、职责边界与可维护性

**禁止：**
- 引入新功能
- 改变任何业务语义或对外接口

---

#### [PERF] 性能与稳定性
**允许：**
- 针对性能、并发、资源占用、稳定性问题进行优化
- 引入必要的性能测试或监控验证

**禁止：**
- 改变业务语义
- 借机进行与性能无关的重构或功能调整

---

#### [DOC] 文档与运行规范
**允许：**
- BUILD 阶段默认不改 AGENTS.md；如确需改，必须先回 PROMPT_plan.md
- 补充明确的操作与执行规范

**禁止：**
- 修改业务代码
- 引入任何功能或行为变化

---

#### [DEBT] 技术债记录
**绝对禁止执行：**
- `[DEBT]` 类任务不得在 BUILD 阶段被实现
- 仅允许记录、更新或移动到 Deferred / Out of Scope 区域

如所选任务为 `[DEBT]`，必须立即停止执行并退出 BUILD 阶段。

---

### 违规处理（强制）

- 若在执行过程中发现当前 Task Kind 与实际所需改动不一致：
  - **立即停止实现**
  - 退出 BUILD 阶段
  - 切换回规划模式澄清任务类型

---

## 实现规则（Implementation Rules）

在实现任务之前：

- 必须先搜索现有代码，确认相关功能是否已存在。
- 必须优先复用 `src/lib/` 中的标准库与既有模式。
- 严禁在其他目录中复制已有的 `src/lib/` 实现。

在实现过程中：

- 只实现当前所选任务所必需的最小改动。
- 遵循现有代码风格、结构与项目约定。
- 不得引入与当前任务无关的修改。

---

## 状态校准规则（Plan–Reality Reconciliation）

在 BUILD 阶段，如发现以下情况：

- 所选任务在历史 commit 中实际上已经完成；
- 当前代码与测试状态满足该任务的所有验收条件；
- 不需要新增或修改任何实现代码；

则你 **必须** 执行以下操作，而不得请求人工确认：

1. 更新 `IMPLEMENTATION_PLAN.md`，将对应任务标记为「已完成」或从 Executable Tasks 中移除；
2. 在任务下方补充一句极简说明（例如：`已在 commit <hash> 中完成，测试全部通过`）；
3. 无需新增“实现代码”改动；
但对 IMPLEMENTATION_PLAN.md 的状态校准必须提交（允许仅文档/计划变更的 commit）；
4. 完成上述状态校准后，自动继续下一轮 BUILD 循环。

该行为视为「状态修正」，不属于规划行为，不需要切换回 PROMPT_plan.md。

---

## 验证规则（Validation Rules）

在完成实现后，必须进行验证：

- 优先运行与当前任务直接相关的测试：
```bash
pytest tests/
```
---

## BUILD 状态写回规则（强制）

在 BUILD 完成并更新 IMPLEMENTATION_PLAN.md 时，必须遵守以下规则：

- 所有尚未完成的任务，必须继续保留在
  “## 可执行任务（Executable Tasks）”区块中
- 不得仅以总结说明、列表或叙述性段落形式列出未完成任务
- 已完成的任务，必须从 “## 可执行任务（Executable Tasks）” 区块中移除
- “## 可执行任务（Executable Tasks）” 区块是 BUILD_ALL 与后续 BUILD 循环
  判断是否继续执行的唯一可信来源

---

## BUILD 终止条件（Terminal Conditions）

在完成状态校准或任务执行后，如出现以下情况：

- `IMPLEMENTATION_PLAN.md` 中 **不存在任何可执行任务（Executable Tasks）**；
- 所有已存在任务均已标记为完成、无效或移出执行区；
- 当前代码与测试状态无未解决失败；

则你 **必须** 执行以下行为（顺序不可改变）：

1. 确认 `IMPLEMENTATION_PLAN.md` 已准确反映当前事实状态；
2. 在输出中 **单独输出且仅输出如下标记行**（完全一致）：

[BUILD_EXIT]
3. **正常结束 BUILD 阶段执行**；
4. 不得请求人工确认；
5. 不得自动切换回 `PROMPT_plan.md`；
6. 不得生成新的规划或建议性任务。

> 说明：  
> `[BUILD_EXIT]` 是 BUILD 阶段的**唯一合法终止信号**，  
> 用于通知外部执行循环（如 `loop.ps1`）安全停止。

该情况视为「BUILD 正常完成」，而非异常或中断。