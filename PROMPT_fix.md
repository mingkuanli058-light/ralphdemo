你当前处于【修复模式（FIXING）】。

你的唯一职责是：
根据指定的 Bug 描述，定位问题根因，完成最小修复，并验证通过后提交。

本模式专为**快速修复已知问题**设计，跳过完整规划阶段以节省 Token。

必须严格遵守 AGENTS.md。
如存在任何冲突，以 AGENTS.md 为最高优先级。

---

## 职责范围（Scope of Responsibility）

在本模式下，你必须：

- 读取 Bug 描述（来自 `specs/bugs/*.md` 或用户直接提供）。
- 通过搜索代码定位问题根因。
- 实现最小必要修复。
- 运行相关测试验证修复。
- 验证通过后提交更改。
- 在 `IMPLEMENTATION_PLAN.md` 末尾追加修复记录。

在本模式下，你严禁：

- 加载或阅读完整的 `specs/*.md` 需求文件（除非 Bug 描述明确引用）。
- 进行需求分析或重新规划。
- 进行与 Bug 无关的重构或优化。
- 同时修复多个 Bug。
- 在测试未通过时提交更改。

---

## 上下文加载规则（Context Loading Rules）

为节省 Token，本模式采用**最小上下文**策略：

必须加载：
- `AGENTS.md`（执行规则）
- 当前 Bug 描述

按需加载：
- 与问题相关的源代码文件（通过搜索定位）
- 相关测试文件

禁止加载：
- 完整的 `specs/*.md`（除非 Bug 明确引用）
- 与问题无关的代码文件

---

## Bug 定位规则（Bug Location Rules）

定位问题时，必须遵循以下步骤：

1. **理解现象**：从 Bug 描述中提取关键信息（错误信息、复现步骤、相关文件提示）。

2. **搜索定位**：使用关键词搜索相关代码。
   - 优先搜索错误信息中的关键字。
   - 搜索 Bug 描述中提到的函数名、变量名、文件名。
   - 如 Bug 描述提供了相关文件路径，直接定位。

3. **确认根因**：找到问题根本原因后再动手修复。
   - 不得在未确认根因的情况下盲目修改。
   - 如无法定位根因，应停止并说明需要更多信息。

---

## 修复规则（Fix Rules）

在修复过程中：

- 只修改与 Bug 直接相关的代码。
- 遵循现有代码风格。
- 不得引入与修复无关的改动。
- 不得进行"顺便优化"或"顺便重构"。
- 如修复涉及多处改动，确认它们都是必要的。

---

## 验证规则（Validation Rules）

修复完成后，必须进行验证：

- 优先运行与修复相关的测试：
```bash
pytest tests/ -k "相关测试名"
```

- 如无法确定相关测试范围，运行完整测试：
```bash
pytest tests/ -q
```

- 如该 Bug 没有对应测试，必须先创建测试：
  1. 编写能复现该 Bug 的测试用例。
  2. 确认测试在修复前失败。
  3. 完成修复后确认测试通过。

- 所有测试必须通过后才能提交。

---

## 提交规则（Commit Rules）

提交信息格式：

```
fix: 简短描述修复内容

- 问题根因：xxx
- 修复方式：xxx
```

示例：
```
fix: 修复身份证号15位格式被错误接受的问题

- 问题根因：正则表达式未限制长度
- 修复方式：添加长度校验，仅接受18位
```

---

## 记录更新规则（Record Update Rules）

提交成功后，在 `IMPLEMENTATION_PLAN.md` 末尾追加修复记录：

```markdown
---

## Bug 修复记录（Bug Fix Log）

| 日期 | Bug ID | 问题描述 | 修复文件 | 根因 |
|------|--------|---------|---------|------|
| YYYY-MM-DD | BUG_xxx | 简述 | 文件路径 | 简述根因 |
```

如该节已存在，直接追加新行即可。

---

## 退出条件（Exit Condition）

完成以下全部步骤后退出：

1. Bug 已修复且测试通过。
2. 更改已提交。
3. 修复记录已追加到 `IMPLEMENTATION_PLAN.md`。

如遇到以下情况，应立即停止并报告：

- 无法定位问题根因。
- Bug 描述信息不足以定位问题。
- 修复需要涉及架构级改动（应转入规划模式）。

---

## Bug 描述文件格式参考（specs/bugs/BUG_xxx.md）

```markdown
# BUG_xxx: 简短标题

## 现象（Symptom）
描述用户看到的错误表现

## 预期（Expected）
描述正确的行为应该是什么

## 复现步骤（Steps to Reproduce）
1. 步骤一
2. 步骤二
3. ...

## 相关文件（可选）（Related Files）
- src/xxx.py
- tests/xxx.py

## 错误日志（可选）（Error Log）
```
粘贴相关错误信息
```
```
